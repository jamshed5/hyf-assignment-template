<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Task Manager Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
</head>

<body>

  <header class="navbar">
    <div><b>Task Manager Dashboard</b></div>
  </header>

  <div class="container">

    <!-- Total Users Card -->
    <div class="card">
      <div class="total-count">
        <h1>Total Users</h1>
        <div class="count" id="count">...</div>
      </div>
    </div>

    <!-- User Table -->
    <div class="user-list">
      <div class="table-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2>Users</h2>
        <a class="add-user-btn" href="/add-user.html">Add New User</a>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="users"></tbody>
      </table>
    </div>

  </div>

  <script>
    // Fetch total user count
    async function loadCount() {
      try {
        const res = await fetch("/users/count");
        const data = await res.json();
        document.getElementById("count").textContent = data.count ?? 0;
      } catch (err) {
        console.error("Failed to fetch count:", err);
      }
    }

    async function loadUsers() {
      try {
        const res = await fetch("/users/");
        let users = await res.json();

        // If nested array, flatten it
        if (Array.isArray(users[0])) users = users[0];

        const tbody = document.getElementById("users");
        tbody.innerHTML = "";

        users.forEach(user => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${user.id}</td>
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>
          <button class="btn btn-update" onclick="location.href='/update-user.html?id=${user.id}'">Update</button>
          <button class="btn btn-delete" onclick="deleteUser(${user.id})">Delete</button>
        </td>
      `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Failed to load users:", err);
      }
    }


    // Delete user
    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      try {
        await fetch(`/users/delete/${id}`, { method: "DELETE" });
        await loadUsers();
        await loadCount();
      } catch (err) {
        console.error("Failed to delete user:", err);
      }
    }

    // Initial load
    loadCount();
    loadUsers();
  </script>

</body>

</html>